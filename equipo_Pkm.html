<!-- equipo_Pkm.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Lista pokemon desde API</title>
  <link rel="stylesheet" type="text/css" href="style.css"/>

  <!-- Fuente pixelada -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Jersey+10&display=swap" rel="stylesheet">
</head>

<div id="navbar"></div>
<body>
  <!-- PÁGINA PRINCIPAL -->
  <p id="tituloComprado" class="jersey-10">Equipo comprado ():</p>
  <div id="comprado"></div>

  <script src="JS/navPkm.js"></script>
  <script>
    const titulo = document.getElementById("tituloComprado");
    const equipo = document.getElementById("comprado");
    let pokeArray = [];

    const capitalizar = (string) => string[0].toUpperCase() + string.slice(1);

    // Leer IDs y convertirlas en URLs
    const params = new URLSearchParams(window.location.search);
    const precio = params.get("precio");
    const leido = params.get("IDs");
    const oscuro = params.get("oscuro");
    let IDs = [];

    if(oscuro != null && oscuro != "no" && oscuro != "false" && oscuro != 0) {
      document.body.classList.add("oscuro");
      document.body.style.transition = "background-color 0s";
      setTimeout(() => {document.body.style.transition = "background-color 1s ease";}, 100);
    }
    if(precio != null) {titulo.innerText = "Equipo comprado (" + String(precio) + "€)";}
    if(leido === null) {
      console.log("No hay equipo para leer");
      equipo.innerText = "No se ha podido leer el equipo en el apartado 'IDs'";
      equipo.style.display = "flex";
    } else {
      IDs = leido.split(',').slice(0, 6); // Solo se cogen los 6 primeros
      while(IDs.length < 6) { IDs.push(null); }
    }

    IDs.forEach((id) => {
      if(id === null) {
        const card = document.createElement('div');
        card.classList.add('cardComprado');
        card.id = 10000;
        card.draggable = "false";
        card.innerHTML = `<div class="contenidoCartaComprado vacia">
                            <p>Slot vacío</p>
                          </div>`;
        pokeArray.push(card);
        pokeArray.sort((a, b) => a.id - b.id);
        if (pokeArray.length == IDs.length) {
          pokeArray.forEach((card) => equipo.appendChild(card));
        }
      } else {
        // Fetch de cada pokemon
        const Pokemon_URL = "https://pokeapi.co/api/v2/pokemon/" + id;
        fetch(Pokemon_URL)
        .then(response => response.json())
        .then(pokeData => {
          // Comprobamos los tipos
          let tiposHTML = '';
          if (pokeData.types.length === 2) {
            tiposHTML = `
              <p style="grid-area: 3 / 3 / 4 / 4; margin-left: 6px;">
                <strong>Tipos: </strong>
                <img src="sources/Tipo_${pokeData.types[0].type.name}.png" alt="${pokeData.types[0].type.name}" draggable="false">
                <img src="sources/Tipo_${pokeData.types[1].type.name}.png" alt="${pokeData.types[1].type.name}" draggable="false">
              </p>`;
          } else {
            tiposHTML = `
              <p style="grid-area: 3 / 3 / 4 / 4; margin-left: 16px;">
                <strong>Tipo: </strong>
                <img src="sources/Tipo_${pokeData.types[0].type.name}.png" alt="${pokeData.types[0].type.name}" draggable="false">
              </p>`;
          }

          // Comprobamos si tiene imagen de frente
          let innerGifFrente = '';
          if (pokeData.sprites.other.showdown.front_default === null) {
            innerGifFrente = `<img src="sources/Pokeball.png" alt="Imagen de una pokeball" draggable="false" class="gif frente">`;
          } else {
            innerGifFrente = `<img src="${pokeData.sprites.other.showdown.front_default}"
                                  draggable="false" alt="Imagen de ${capitalizar(pokeData.name)}" class="gif frente">`;
          }

          // Comprobamos si tiene imagen de espalda
          let innerGifEspalda = '';
          if (pokeData.sprites.other.showdown.back_default === null) {
            innerGifEspalda = `<img src="sources/Pokeball.png" alt="Imagen de una pokeball" draggable="false" class="gif espalda">`;
          } else {
            innerGifEspalda = `<img src="${pokeData.sprites.other.showdown.back_default}"
                                  alt="Imagen de ${capitalizar(pokeData.name)} de espalda" draggable="false" class="gif espalda">`;
          }

          // Creamos la tarjeta del pokemon
          const card = document.createElement('div');
          const precio = Math.ceil(Math.pow(
            pokeData.stats[0].base_stat +
            pokeData.stats[1].base_stat +
            pokeData.stats[2].base_stat +
            pokeData.stats[3].base_stat +
            pokeData.stats[4].base_stat +
            pokeData.stats[5].base_stat, 2)/10)/100;
          card.classList.add('cardComprado');
          card.id = pokeData.id;
          card.draggable = "false";
          card.innerHTML = `
            <div class="contenidoCartaComprado" id="frente${pokeData.id}">
              <div class="contenedorGif">${innerGifFrente}${innerGifEspalda}</div>
              <p style="grid-area: 1 / 1 / 2 / 3; font-size: 27px" class="jersey-10">${capitalizar(pokeData.name)}</p>
              <p style="grid-area: 1 / 3 / 2 / 4;">
                <strong style="margin-left: 2px">ID: </strong>${pokeData.id}
                <strong style="margin-left: 10px">Precio: </strong>${precio}€
              </p>
              <div class="estadisticas" style="gap: 0; margin-top: 4px;">
                ${pokeData.stats.map((s,i) => {
                  const nombres = ["Hp","Atq","Def","A.E","D.E","Vel"];
                  const colores = ["green","crimson","blue","red","blueviolet","aqua"];
                  const maximos = [255,181,230,173,230,200];
                  return `
                    <div class="estadistica">
                      <p style="font-size: 27px" class="jersey-10">${nombres[i]}:</p>
                      <div class="contenedorBarra">
                        <p>${s.base_stat}</p>
                        <div class="barra" style="width:${s.base_stat*100/maximos[i]}%;background-color:${colores[i]};"></div>
                      </div>
                    </div>`;
                }).join('')}
                <div class="alturaYpeso">
                  <p style="margin: 0;">Altura: ${pokeData.height/10}m</p>
                  <p style="margin: 0;">Peso: ${pokeData.weight/10}kg</p>
                </div>
              </div>
              ${tiposHTML}
            </div>`;

          // Evento click para voltear gif
          const voltearGif = card.firstElementChild.firstElementChild;
          voltearGif.addEventListener('click', () => {
            const delante = voltearGif.firstElementChild;
            const detras = voltearGif.lastElementChild;
            if (voltearGif.classList.contains("vuelta")) {
              voltearGif.classList.remove("vuelta");
              setTimeout(() => {
                detras.style.opacity = "0";
                delante.style.opacity = "1";
              }, 150);
            } else {
              voltearGif.classList.add("vuelta");
              setTimeout(() => {
                delante.style.opacity = "0";
                detras.style.opacity = "1";
              }, 150);
            }
          });

          pokeArray.push(card);
          pokeArray.sort((a, b) => a.id - b.id);
          if (pokeArray.length == IDs.length) {
            pokeArray.forEach((card) => equipo.appendChild(card));
          }
        })
        .catch(error => console.error("❌ Error al conectar con la API:", error));
      }
    });
  </script>
</body>
</html>
